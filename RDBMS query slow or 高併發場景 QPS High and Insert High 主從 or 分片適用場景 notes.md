# RDBMS query slow or 高併發場景 QPS High and Insert High 主從 or 分片適用場景 notes

## monitor pointer

### 查詢延遲時間高，CPU負載高：

複雜的關聯查詢或查詢邏輯負載大，優化複合索引增加覆蓋，縮小命中返回的範圍

### 每秒查詢數(QPS)高，連接數高，記憶體使用率高：

主從模式做負載平衡，增加多節點（從節點），提高連接數

### 寫入表頁面數高、磁碟寫入數高：

資料分片分散寫入壓力

### 影響記憶體的可能：

- 熱資料緩存越多越大
- 大量連線或 connection pool 太大
- 大型的查詢、排序、JOIN

### 實作上

透過 cloud service 的監控服務或監控工具，去監控一些關鍵指標如： CPU 負載、記憶體負載、連接數、每秒查詢時間、查詢延遲時間等等

舉例來說查詢延遲時間高，CPU負載高，但每秒查詢低、連接數低可能是邏輯偏重或索引沒命中或請求太多資料，可能就要優化索引去增加覆蓋，縮小命中返回的筆數範圍，縮小返回的資料量

記憶體使用率高、連接數高、每秒查詢數高，較偏向是 RPS 高併發的問題，是主從模式適合的場景

寫入表引擎頁面數、磁碟寫入數 這些指標顯示的是寫入壓力，是分片適合的場景

### 主從 replication

適合處理高併發查詢的場景，提供了多個唯讀節點，分攤了單一節點的負載

會有資料一致性的問題，即寫節點跟讀節點的資料同步時間落差，不同的資料庫對一致性的支援有差別

### 分片 Sharding

適合處理高併發寫入的場景，將一個高頻率寫入的資料主題透過分組（hash、% id 、 date time、不同小主題）區分不同的寫入節點，分攤了單一寫節點的負載

需要考慮資料分布的規則，使資料分布均勻

需要考慮單點故障問題，Sharding 等於不同的資料分散在不同的機器上，寫入請求也會根據分組邏輯分散在不同機器上，進行主從模式保證可用性

實務上，在計算涉及多個節點資料的情況下，採最終一致性策略，定時更新統計數據於一個節點（或主從群集），並不做實時的跨節點統計，那樣的時間成本大，還需考慮網路分區的問題

在 Transaction 的場景中，涉及多個節點資料的情況下，需採用 2PC 或 最終一致性的策略

### 

不了解的：

gcp 確實有提到分片，但 gcp 到底怎麼做分片